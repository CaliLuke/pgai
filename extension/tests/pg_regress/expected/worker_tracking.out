-- Test worker tracking tables and functions
-- This test validates:
--   1. _worker_start registers a worker and returns a UUID
--   2. _worker_heartbeat accumulates counts and tracks errors
--   3. _worker_progress upserts per-vectorizer progress
--   4. Progress tracks success and error paths independently
--   5. Progress updated_at is always set
--   6. Multiple heartbeats accumulate correctly
-------------------------------------------------------------------------------
-- Test 1: _worker_start registers a worker
-------------------------------------------------------------------------------
SELECT ai._worker_start('0.1.0', interval '5 seconds') IS NOT NULL AS has_worker_id;
 has_worker_id 
---------------
 t
(1 row)

-- Verify the row was created
SELECT version, heartbeat_count, success_count, error_count,
       last_error_at IS NULL AS no_error_at,
       last_error_message IS NULL AS no_error_msg
FROM ai.vectorizer_worker_process
ORDER BY started DESC LIMIT 1;
 version | heartbeat_count | success_count | error_count | no_error_at | no_error_msg 
---------+-----------------+---------------+-------------+-------------+--------------
 0.1.0   |               0 |             0 |           0 | t           | t
(1 row)

-------------------------------------------------------------------------------
-- Test 2: _worker_heartbeat with successes only
-------------------------------------------------------------------------------
-- Get the worker id for use in subsequent tests
DO $$
DECLARE
    wid uuid;
BEGIN
    SELECT id INTO wid FROM ai.vectorizer_worker_process ORDER BY started DESC LIMIT 1;
    PERFORM set_config('test.worker_id', wid::text, false);
END $$;
SELECT ai._worker_heartbeat(
    current_setting('test.worker_id')::uuid,
    10, 0, NULL
);
 _worker_heartbeat 
-------------------
 
(1 row)

SELECT heartbeat_count, success_count, error_count,
       last_error_at IS NULL AS no_error_at,
       last_error_message IS NULL AS no_error_msg
FROM ai.vectorizer_worker_process
WHERE id = current_setting('test.worker_id')::uuid;
 heartbeat_count | success_count | error_count | no_error_at | no_error_msg 
-----------------+---------------+-------------+-------------+--------------
               1 |            10 |           0 | t           | t
(1 row)

-------------------------------------------------------------------------------
-- Test 3: _worker_heartbeat with errors
-------------------------------------------------------------------------------
SELECT ai._worker_heartbeat(
    current_setting('test.worker_id')::uuid,
    5, 3, 'test error 1'
);
 _worker_heartbeat 
-------------------
 
(1 row)

SELECT heartbeat_count, success_count, error_count,
       last_error_at IS NOT NULL AS has_error_at,
       last_error_message
FROM ai.vectorizer_worker_process
WHERE id = current_setting('test.worker_id')::uuid;
 heartbeat_count | success_count | error_count | has_error_at | last_error_message 
-----------------+---------------+-------------+--------------+--------------------
               2 |            15 |           3 | t            | test error 1
(1 row)

-------------------------------------------------------------------------------
-- Test 4: _worker_heartbeat preserves last_error when no new error
-------------------------------------------------------------------------------
SELECT ai._worker_heartbeat(
    current_setting('test.worker_id')::uuid,
    7, 0, NULL
);
 _worker_heartbeat 
-------------------
 
(1 row)

SELECT heartbeat_count, success_count, error_count,
       last_error_message
FROM ai.vectorizer_worker_process
WHERE id = current_setting('test.worker_id')::uuid;
 heartbeat_count | success_count | error_count | last_error_message 
-----------------+---------------+-------------+--------------------
               3 |            22 |           3 | test error 1
(1 row)

-------------------------------------------------------------------------------
-- Test 5: _worker_heartbeat updates last_error on new error
-------------------------------------------------------------------------------
SELECT ai._worker_heartbeat(
    current_setting('test.worker_id')::uuid,
    0, 1, 'test error 2'
);
 _worker_heartbeat 
-------------------
 
(1 row)

SELECT heartbeat_count, success_count, error_count,
       last_error_message
FROM ai.vectorizer_worker_process
WHERE id = current_setting('test.worker_id')::uuid;
 heartbeat_count | success_count | error_count | last_error_message 
-----------------+---------------+-------------+--------------------
               4 |            22 |           4 | test error 2
(1 row)

-------------------------------------------------------------------------------
-- Test 6: _worker_progress — success path (new vectorizer)
-------------------------------------------------------------------------------
-- Create a source table and vectorizer for progress tests
CREATE TABLE public.progress_test (
    id serial PRIMARY KEY,
    content text NOT NULL
);
DO $$
DECLARE
    vid int4;
BEGIN
    SELECT ai.create_vectorizer(
        'public.progress_test'::regclass,
        loading    => ai.loading_column('content'),
        embedding  => ai.embedding_openai('text-embedding-3-small', 1536),
        chunking   => ai.chunking_none(),
        formatting => ai.formatting_chunk_value(),
        enqueue_existing => false
    ) INTO vid;
    PERFORM set_config('test.vectorizer_id', vid::text, false);
END $$;
-- First success: should insert a new progress row
SELECT ai._worker_progress(
    current_setting('test.worker_id')::uuid,
    current_setting('test.vectorizer_id')::int4,
    5, NULL
);
 _worker_progress 
------------------
 
(1 row)

SELECT success_count, error_count,
       last_success_at IS NOT NULL AS has_success_at,
       last_success_process_id IS NOT NULL AS has_success_pid,
       last_error_at IS NULL AS no_error_at,
       last_error_message IS NULL AS no_error_msg,
       last_error_process_id IS NULL AS no_error_pid,
       updated_at IS NOT NULL AS has_updated_at
FROM ai.vectorizer_worker_progress
WHERE vectorizer_id = current_setting('test.vectorizer_id')::int4;
 success_count | error_count | has_success_at | has_success_pid | no_error_at | no_error_msg | no_error_pid | has_updated_at 
---------------+-------------+----------------+-----------------+-------------+--------------+--------------+----------------
             5 |           0 | t              | t               | t           | t            | t            | t
(1 row)

-------------------------------------------------------------------------------
-- Test 7: _worker_progress — error path (existing vectorizer)
-------------------------------------------------------------------------------
SELECT ai._worker_progress(
    current_setting('test.worker_id')::uuid,
    current_setting('test.vectorizer_id')::int4,
    0, 'embedding failed'
);
 _worker_progress 
------------------
 
(1 row)

SELECT success_count, error_count,
       last_success_at IS NOT NULL AS has_success_at,
       last_error_at IS NOT NULL AS has_error_at,
       last_error_message,
       last_error_process_id IS NOT NULL AS has_error_pid
FROM ai.vectorizer_worker_progress
WHERE vectorizer_id = current_setting('test.vectorizer_id')::int4;
 success_count | error_count | has_success_at | has_error_at | last_error_message | has_error_pid 
---------------+-------------+----------------+--------------+--------------------+---------------
             5 |           1 | t              | t            | embedding failed   | t
(1 row)

-------------------------------------------------------------------------------
-- Test 8: _worker_progress — success after error preserves error info
-------------------------------------------------------------------------------
SELECT ai._worker_progress(
    current_setting('test.worker_id')::uuid,
    current_setting('test.vectorizer_id')::int4,
    3, NULL
);
 _worker_progress 
------------------
 
(1 row)

SELECT success_count, error_count,
       last_error_message
FROM ai.vectorizer_worker_progress
WHERE vectorizer_id = current_setting('test.vectorizer_id')::int4;
 success_count | error_count | last_error_message 
---------------+-------------+--------------------
             8 |           1 | embedding failed
(1 row)

-------------------------------------------------------------------------------
-- Test 9: multiple workers can update the same vectorizer progress
-------------------------------------------------------------------------------
-- Start a second worker
SELECT ai._worker_start('0.2.0', interval '10 seconds') IS NOT NULL AS has_worker2_id;
 has_worker2_id 
----------------
 t
(1 row)

DO $$
DECLARE
    wid uuid;
BEGIN
    SELECT id INTO wid FROM ai.vectorizer_worker_process
    WHERE version = '0.2.0' ORDER BY started DESC LIMIT 1;
    PERFORM set_config('test.worker2_id', wid::text, false);
END $$;
SELECT ai._worker_progress(
    current_setting('test.worker2_id')::uuid,
    current_setting('test.vectorizer_id')::int4,
    10, NULL
);
 _worker_progress 
------------------
 
(1 row)

-- Counts should accumulate, last_success_process_id should be worker2
SELECT success_count, error_count,
       last_success_process_id = current_setting('test.worker2_id')::uuid AS is_worker2
FROM ai.vectorizer_worker_progress
WHERE vectorizer_id = current_setting('test.vectorizer_id')::int4;
 success_count | error_count | is_worker2 
---------------+-------------+------------
            18 |           1 | t
(1 row)

-------------------------------------------------------------------------------
-- Test 10: drop_vectorizer cascades to progress
-------------------------------------------------------------------------------
SELECT ai.drop_vectorizer(
    current_setting('test.vectorizer_id')::int4,
    drop_all => true
);
 drop_vectorizer 
-----------------
 
(1 row)

SELECT count(*) AS progress_after_drop
FROM ai.vectorizer_worker_progress
WHERE vectorizer_id = current_setting('test.vectorizer_id')::int4;
 progress_after_drop 
---------------------
                   0
(1 row)

-------------------------------------------------------------------------------
-- Teardown
-------------------------------------------------------------------------------
DROP TABLE public.progress_test CASCADE;
DELETE FROM ai.vectorizer_worker_process;
